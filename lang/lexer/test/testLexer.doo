module testLexer 

import ../lexer
import ../../../std/io


fn {s Strings, str string} checkStr(id Idx)
    data result string 
    {s, result}.read(id)
    let true = str == result


fn testLexInt()
    data s Strings "test2 123"
    let null = s.lexInt(0)
    let Success(LexInt(2), 5) = s.lexInt(4)


fn testLexIdent()
    data s Strings " test2 123"
    let null = s.lexIdent(0)
    let Success(LexIdent(n), 6)  = s.lexIdent(1)

    data result string
    {s, result}.read(n)
    let "test2" = result


fn testLexKeyword()
    data s Strings " return 2 for123"

    let null = s.lexKeyword(0)
    let Success(LexKeyword(id), 7) = s.lexKeyword(1)
    let null = s.lexKeyword(10)

    data result string
    {s, result}.read(id)
    let "return" = result

fn testLexSym()
    data s Strings " /ret?urn+35- % "
    let null = s.lexSym(0)
    let Success(LexSym('/'), 2) = s.lexSym(1)
    let null = s.lexSym(4)
    let Success(LexSym('+'), 10) = s.lexSym(9)


fn testLexDoubleSym() 
    data s Strings " ->ret..urn+35 ->% "

    let null = s.lexDoubleSym(0)
    let Success(LexDoubleSym('-', '>'), 3) = s.lexDoubleSym(1)
    let null = s.lexDoubleSym(7)
    let null = s.lexDoubleSym(5)
    let Success(LexDoubleSym('.', '.'), 8) = s.lexDoubleSym(6)


fn testLexNewline()
    data s Strings "stuff \n  moreStuff\n\t\t"
    let null = s.lexNewline(0)
    let Success(LexNewline(id0), 9)  = s.lexNewline(6)
    let null = s.lexNewline(7)
    let Success(LexNewline(id1), 21)  = s.lexNewline(18)

    {s, "  "}.checkStr(id0)
    {s, "\t\t"}.checkStr(id1)
// not working?

//    another comment // more comments
fn testLexComment() // comment
    data s Strings "blargh\n//comment  stuff\t \nmore"
    let null = s.lexComment(0)
    let null = s.lexComment(6)
    let Success(LexComment(), 25) = s.lexComment(7)
    let null = s.lexComment(8)


fn testLexNewlineWithComment()
    data s Strings "   \t\t\n//comment\n\t\n\t"
    let Success(LexNewline(id), 19) = s.lexNewline(0)


fn testLexCharLit()
    data s Strings "stuff '\\n' more'\\0'na'j'df"
    let null = s.lexCharLit(0)
    let Success(LexCharLit('\n'), 10) = s.lexCharLit(6)
    let null = s.lexCharLit(14)
    let Success(LexCharLit('\0'), 19) = s.lexCharLit(15)
    let null = s.lexCharLit(16)
    let Success(LexCharLit('j'), 24) = s.lexCharLit(21)


fn testLexStringLit()
    data s Strings "s\"str+ 123\"\t more"
    let null = s.lexStringLit(0)
    let Success(LexStringLit(id0), _) = s.lexStringLit(1)
    let null = s.lexStringLit(6)
    {s, "str+ 123"}.checkStr(id0)


fn testLexEscaped()
    data s Strings "s\\n+ 13\\\\more"
    let null = s.lexEscaped(0)
    let Success(LexChar('\n'), 3) = s.lexEscaped(1)
    let null = s.lexEscaped(2)
    let Success(LexChar('\\'), 9) = s.lexEscaped(7)
    let null = s.lexEscaped(6)


fn testLexImport()
    data s Strings " import ../someDir/someFile; someNonsense"
    let null = s.lexImport(0)
    let Success(LexImport(id), 27) = s.lexImport(1)
    let null = s.lexImport(2)
    {s, "../someDir/someFile"}.checkStr(id)


fn testLexFunnyString()
    data s Strings "\"abStr98.<?\""
    let Success(x, y) = s.lexStringLit(0)


    data s2 Strings "\"stuff '\\n' more'\\0'na'j'df\""
    let Success(_, _) = s2.lexStringLit(0)

fn {io Io} main() 
    testLexInt()
    testLexIdent()
    testLexKeyword()
    testLexSym()
    testLexDoubleSym() 
    testLexNewline()
    testLexCharLit()
    testLexStringLit()
    testLexEscaped()
    testLexImport()
    testLexFunnyString()
    testLexNewlineWithComment()
    testLexComment()
    io.write("testLexer passed\n")

